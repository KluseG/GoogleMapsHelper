"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var GoogleMapsHelper=function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};for(var d in _classCallCheck(this,a),this.element=b,this.initialized=!1,this.infoWindow=!1,this.markers=[],this.options={center:"Mountain View, California",fallbackZoom:6,google:{callback:"initMap",key:null,language:"en",region:"US",url:"https://maps.googleapis.com/maps/api/js"},infoWindow:!1,iniDelay:500,markers:!1,maxZoom:21,minZoom:1,on:{initialized:null,markerCreated:null,markerSpawned:null},throttle:{apply:!0,rate:50}},this.queue=[],this.options)if("undefined"!=typeof c[d])if("object"==_typeof(this.options[d]))for(var e in this.options[d])"undefined"!=typeof c[d][e]&&(this.options[d][e]=c[d][e]);else this.options[d]=c[d];var f=document.createElement("script");f.src=this._getUrl(),document.body.appendChild(f)}return _createClass(a,[{key:"init",value:function(){var a=this;return setTimeout(function(){a._initialize()},this.options.iniDelay),this}},{key:"setCenterOn",value:function(a){var b=this;this._call("geoCode",a).then(function(a){b._call("getCenter",a.geometry).then(function(c){b.map.setZoom(b.options.fallbackZoom),b.map.panTo(c.center),b.map.setZoom(b._getZoom(a.geometry.viewport))})})}},{key:"_call",value:function(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];var e=this;return new Promise(function(b,d){return e["_"+a](e,{resolve:b,reject:d},c)})}},{key:"_initialize",value:function(){var a=this;if("object"!=("undefined"==typeof google?"undefined":_typeof(google)))throw"Google object not found! Try increasing \"iniDelay\" value.";this.google=google.maps;var b=this;return this._call("geoCode",this.options.center).then(function(c){a._call("getCenter",c.geometry).then(function(d){a.map=new a.google.Map(a.element,d),setTimeout(function(){b.map.setZoom(b._getZoom(c.geometry.bounds||c.geometry.viewport))},a.options.iniDelay/2),!1!=a.options.markers&&a._call("setMarkers",a.options.markers).then(function(b){!1!=a.options.infoWindow&&a._call("setWindows",b,a.options.infoWindow)})})}),null===this.options.on.initialized||this.options.on.initialized()}},{key:"_closeWindow",value:function(a,b){return!1!==a.infoWindow&&(a.infoWindow.close(),a.infoWindow=!1),b.resolve(!0)}},{key:"_setWindows",value:function(a,b,c){var d=c[0],e=c[1],f=!0,g=!1,h=void 0;try{for(var i,j=function(){var b=i.value;a.google.event.addListener(b.marker,"click",function(){a._call("closeWindow").then(function(){var c=new a.google.InfoWindow({content:a._parseTemplate(e,b.data)});c.open(a.map,b.marker),a.infoWindow=c})})},k=d[Symbol.iterator]();!(f=(i=k.next()).done);f=!0)j()}catch(a){g=!0,h=a}finally{try{f||null==k.return||k.return()}finally{if(g)throw h}}return b.resolve(!0)}},{key:"_setMarkers",value:function(a,b,c){var d=c[0].length,e=!0,f=!1,g=void 0;try{for(var h,i=function(){var b=h.value;if("undefined"==typeof b.lat||"undefined"==typeof b.lng||1>b.lat.length||1>b.lng.length)a._call("geoCode",b.geocode).then(function(c){var d={marker:new a.google.Marker({map:a.map,position:new a.google.LatLng(c.geometry.location.lat(),c.geometry.location.lng()),title:b.title,icon:b.icon||null}),data:b};a.markers.push(d),null!==a.options.on.markerCreated&&a.options.on.markerCreated(d),null!==a.options.on.markerSpawned&&a.options.on.markerSpawned(d)});else{var c={marker:new a.google.Marker({map:a.map,position:new a.google.LatLng(b.lat,b.lng),title:b.title,icon:b.icon||null}),data:b};a.markers.push(c),null!==a.options.on.markerSpawned&&a.options.on.markerSpawned(c)}},j=c[0][Symbol.iterator]();!(e=(h=j.next()).done);e=!0)i()}catch(a){f=!0,g=a}finally{try{e||null==j.return||j.return()}finally{if(f)throw g}}window.gIntv=setInterval(function(){a.markers.length==d&&(clearInterval(gIntv),b.resolve(a.markers))},200)}},{key:"_getCenter",value:function(a,b,c){var d=new a.google.LatLng(c[0].location.lat(),c[0].location.lng());return b.resolve({center:d,zoom:a.options.fallbackZoom})}},{key:"_geoCode",value:function(a,b,c){this._throttle(function(){new a.google.Geocoder().geocode({address:c[0]},function(a,c){return"OK"==c?b.resolve(a[0]):b.reject(c)})})}},{key:"_process",value:function(){var a=this;0<this.queue.length&&"undefined"==typeof window.gQueueIntv&&(window.gQueueIntv=setInterval(function(){0<a.queue.length?(a.queue[0](),a.queue.shift()):clearInterval(gQueueIntv)},this.options.throttle.rate))}},{key:"_throttle",value:function(a){return this.options.throttle.apply?void(this.queue.push(a),this._process()):a()}},{key:"_parseTemplate",value:function(a,b){var c=a;return a.match(/{{\s*[\w\.]+\s*}}/g).map(function(a){var d=new RegExp(a,"g");c=c.replace(d,b[a.match(/[\w\.]+/)[0]])}),c}},{key:"_getUrl",value:function(){return this.options.google.url+"?key="+this.options.google.key+"&callback="+this.options.google.callback+"&language="+this.options.google.language+"&region="+this.options.google.region}},{key:"_getZoom",value:function(a){for(var b=Math.abs,c=this.map.mapTypes.get(this.map.getMapTypeId()).maxZoom||this.options.maxZoom,d=this.map.mapTypes.get(this.map.getMapTypeId()).minZoom||this.options.minZoom,e=this.map.getProjection().fromLatLngToPoint(a.getNorthEast()),f=this.map.getProjection().fromLatLngToPoint(a.getSouthWest()),g=b(e.x-f.x),h=b(e.y-f.y),i=40,j=c;j>=d;--j)if(g*(1<<j)+2*i<this.map.getDiv().offsetWidth&&h*(1<<j)+2*i<this.map.getDiv().offsetHeight)return j;return this.options.fallbackZoom}}]),a}();